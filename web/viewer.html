<!DOCTYPE html>
<head>
  <title>Data Viewer</title>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <h1>
    Data Viewer

    <span class="infoButton"
      >ℹ️
      <span class="tooltipText">
        You can flag samples using CTRL + click
        <br />
        Then use the console (flaggedSamples variable).
      </span>
    </span>
  </h1>
  <div id="inputContainer">
    <div id="predictedLabelContainer"></div>
  </div>
  <div id="chartContainer">
    <div id="confusionContainer"></div>
  </div>
  <div id="controlPannel">
    <button onclick="toggleInput()">Toggle Input</button>
    <button onclick="toggleOutput()">Toggle Output</button>
    <div id="stats"></div>
  </div>
  <div id="container"></div>

  <script src="../common/js_objects/features.js"></script>
  <script src="../common/js_objects/training.js"></script>
  <script src="../common/js_objects/testing.js"></script>
  <script src="../common/js_objects/minMax.js"></script>
  <script src="../common/constants.js"></script>
  <script src="../common/utils.js"></script>
  <script src="../common/draw.js"></script>
  <script src="../common/feature_fns.js"></script>
  <script src="../common/classifiers/knn.js"></script>

  <script src="js/display.js"></script>
  <script src="js/sketchPad.js"></script>
  <script src="js/dataCleaner.js"></script>

  <script src="./chart/chart.js"></script>
  <script src="./chart/graphics.js"></script>
  <script src="./chart/math.js"></script>
  <script src="./chart/confusion.js"></script>

  <script>
    let { samples, featureNames } = features;
    const trainingSamples = training.samples;
    const testingSamples = testing.samples;
    let correctCnt = 0;
    let totalCnt = 0;
    const k = 50;
    const knn = new KNN(trainingSamples, k);
    for (const testSample of testingSamples) {
      testSample.truth = testSample.label;
      testSample.label = "?";
      const { label } = knn.predict(testSample.point);
      testSample.label = label;
      testSample.correct = testSample.label == testSample.truth;
      totalCnt++;
      if (testSample.correct) {
        correctCnt++;
      }
    }

    stats.innerHTML =
      "<b>ACCURACY</b><br>" +
      correctCnt +
      "/" +
      totalCnt +
      "(" +
      utils.formatPercent(correctCnt / totalCnt) +
      ")";
    const trainingGroups = utils.groupBy(trainingSamples, "student_id");
    for (let stuid in trainingGroups) {
      const sample = trainingGroups[stuid];
      const name = sample[0].student_name;
      createRow(container, name, sample);
    }

    const subtitle = document.createElement("h2");
    subtitle.innerHTML = "TESTING";
    container.appendChild(subtitle);

    const testingGroups = utils.groupBy(testingSamples, "student_id");
    for (let stuid in testingGroups) {
      const sample = testingGroups[stuid];
      const name = sample[0].student_name;
      createRow(container, name, sample);
    }

    const options = {
      size: 500,
      axesLabels: featureNames,
      styles: utils.styles,
      transparency: 0.7,
      icon: "image",
      bg: new Image(),
      // icon: "text"
    };

    options.bg.src = constants.DECISION_BOUNDARY;

    graphics.generateImages(utils.styles);
    const chart = new Chart(
      chartContainer,
      testingSamples.filter((s) => s.truth == "pencil" && s.label == "clock"),
      options,
      handleClick
    );
    const confusion = new Confusion(
      confusionContainer,
      testingSamples,
      utils.classes,
      options
    );

    const sketchPad = new SketchPad(inputContainer, onDrawingUpdate);
    toggleInput();

    sketchPad.canvas.style.cssText +=
      "outline:10000000px solid rgba(0,0,0,0.7);";

    function onDrawingUpdate(paths) {
      const fns = featureFns.inUse.map((fn) => fn.function);
      const point = fns.map((f) => f(paths));
      utils.normalizePoints([point], minMax);
      const { label, nearestSamples } = knn.predict(point);
      predictedLabelContainer.innerHTML = `Is it a ${label} ?`;
      chart.showDynamicPoint(point, label, nearestSamples);
    }
  </script>
</body>
